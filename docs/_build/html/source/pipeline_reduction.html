
<!DOCTYPE html>

<html>
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Pipeline reduction &#8212; zeus2_toolbox 1.2 documentation</title>

    <link href="../_static/css/theme.css" rel="stylesheet">
    <link href="../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">


    <link href="../_static/vendor/fontawesome/5.13.0/css/all.min.css"
          rel="stylesheet">
    <link as="font" crossorigin href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2" rel="preload"
          type="font/woff2">
    <link as="font" crossorigin href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2" rel="preload"
          type="font/woff2">


    <link href="../_static/pygments.css" rel="stylesheet" type="text/css"/>
    <link href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" rel="stylesheet"
          type="text/css"/>
    <link href="../_static/togglebutton.css" rel="stylesheet" type="text/css"/>
    <link href="../_static/mystnb.css" rel="stylesheet" type="text/css"/>

    <link as="script" href="../_static/js/index.be7d3bbb2ef33a8344ce.js" rel="preload">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <link href="../genindex.html" rel="index" title="Index"/>
    <link href="../search.html" rel="search" title="Search"/>
    <link href="README.html" rel="next" title="Documentation"/>
    <link href="../index.html" rel="prev" title="zeus2_toolbox"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <meta content="None" name="docsearch:language">


    <!-- Google Analytics -->

</head>
<body data-offset="80" data-spy="scroll" data-target="#bd-toc-nav">

<div class="container-fluid" id="banner"></div>


<div class="container-xl">
    <div class="row">

        <div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">

            <div class="navbar-brand-box">
                <a class="navbar-brand text-wrap" href="../index.html">


                    <h1 class="site-logo" id="site-title">zeus2_toolbox 1.2 documentation</h1>

                </a>
            </div>
            <form action="../search.html" class="bd-search d-flex align-items-center" method="get">
                <i class="icon fas fa-search"></i>
                <input aria-label="Search the docs ..." autocomplete="off" class="form-control" id="search-input"
                       name="q" placeholder="Search the docs ..." type="search">
            </form>
            <nav aria-label="Main" class="bd-links" id="bd-docs-nav">
                <div class="bd-toc-item active">
                    <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Jupyter notebook exampls:
 </span>
                    </p>
                    <ul class="current nav bd-sidenav">
                        <li class="toctree-l1 current active">
                            <a class="current reference internal" href="#">
                                Pipeline reduction
                            </a>
                        </li>
                    </ul>
                    <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Contents:
 </span>
                    </p>
                    <ul class="nav bd-sidenav">
                        <li class="toctree-l1">
                            <a class="reference internal" href="README.html">
                                Documentation
                            </a>
                        </li>
                        <li class="toctree-l1">
                            <a class="reference internal" href="zeus2_toolbox.html">
                                API
                            </a>
                        </li>
                    </ul>

                </div>
            </nav> <!-- To handle the deprecated key -->

            <div class="navbar_extra_footer">
                Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
            </div>

        </div>


        <main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">

            <div class="topbar container-xl fixed-top">
                <div class="topbar-contents row">
                    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
                    <div class="col pl-md-4 topbar-main">

                        <button aria-controls="navbar-menu" aria-controls="site-navigation" aria-expanded="true"
                                aria-label="Toggle navigation"
                                class="navbar-toggler ml-0" data-placement="bottom" data-placement="left"
                                data-target=".site-navigation"
                                data-toggle="collapse" data-toggle="tooltip" data-toggle="tooltip"
                                id="navbar-toggler" title="Toggle navigation" type="button">
                            <i class="fas fa-bars"></i>
                            <i class="fas fa-arrow-left"></i>
                            <i class="fas fa-arrow-up"></i>
                        </button>


                        <div class="dropdown-buttons-trigger">
                            <button aria-label="Download this page" class="btn btn-secondary topbarbtn"
                                    id="dropdown-buttons-trigger"><i
                                    class="fas fa-download"></i></button>

                            <div class="dropdown-buttons">
                                <!-- ipynb file if we had a myst markdown file -->

                                <!-- Download raw file -->
                                <a class="dropdown-buttons" href="../_sources/source/pipeline_reduction.ipynb.txt">
                                    <button class="btn btn-secondary topbarbtn"
                                            data-placement="left" data-toggle="tooltip" title="Download source file"
                                            type="button">.ipynb
                                    </button>
                                </a>
                                <!-- Download PDF via print -->
                                <button class="btn btn-secondary topbarbtn" data-placement="left" data-toggle="tooltip"
                                        id="download-print"
                                        onClick="window.print()" title="Print to PDF" type="button">.pdf
                                </button>
                            </div>
                        </div>

                        <!-- Source interaction buttons -->

                        <div class="dropdown-buttons-trigger">
                            <button aria-label="Connect with source repository" class="btn btn-secondary topbarbtn"
                                    id="dropdown-buttons-trigger"><i class="fab fa-github"></i></button>
                            <div class="dropdown-buttons sourcebuttons">
                                <a class="repository-button"
                                   href="https://github.com/bpqdbpqd/zeus2_toolbox">
                                    <button class="btn btn-secondary topbarbtn" data-placement="left"
                                            data-toggle="tooltip" title="Source repository" type="button"><i
                                            class="fab fa-github"></i>repository
                                    </button>
                                </a>


                            </div>
                        </div>

                        <!-- Full screen (wrap in <a> to have style consistency -->

                        <a class="full-screen-button">
                            <button aria-label="Fullscreen mode" class="btn btn-secondary topbarbtn"
                                    data-placement="bottom"
                                    data-toggle="tooltip" onclick="toggleFullScreen()" title="Fullscreen mode"
                                    type="button"><i
                                    class="fas fa-expand"></i></button>
                        </a>

                        <!-- Launch buttons -->

                    </div>

                    <!-- Table of contents -->
                    <div class="d-none d-md-block col-md-2 bd-toc show">

                        <div class="tocsection onthispage pt-5 pb-3">
                            <i class="fas fa-list"></i> Contents
                        </div>
                        <nav aria-label="Page" id="bd-toc-nav">
                            <ul class="visible nav section-nav flex-column">
                                <li class="toc-h2 nav-item toc-entry">
                                    <a class="reference internal nav-link" href="#data-reduction-on-science-target">
                                        Data reduction on science target
                                    </a>
                                </li>
                                <li class="toc-h2 nav-item toc-entry">
                                    <a class="reference internal nav-link" href="#data-reduction-on-calibration-source">
                                        Data reduction on calibration source
                                    </a>
                                </li>
                                <li class="toc-h2 nav-item toc-entry">
                                    <a class="reference internal nav-link"
                                       href="#reduction-of-zpold-or-zpoldbig-raster">
                                        Reduction of zpold or zpoldbig raster
                                    </a>
                                </li>
                            </ul>

                        </nav>
                    </div>
                </div>
            </div>
            <div class="row" id="main-content">
                <div class="col-12 col-md-9 pl-md-3 pr-md-0">

                    <div>

                        <div class="tex2jax_ignore mathjax_ignore section" id="pipeline-reduction">
                            <h1>Pipeline reduction<a class="headerlink" href="#pipeline-reduction"
                                                     title="Permalink to this headline">¶</a></h1>
                            <p>This is a tutorial about how to use the <code class="docutils literal notranslate"><span
                                    class="pre">zeus2_toolbox</span></code> package to read, write, analyze and
                                visualize ZEUS2 data. First we need to import the <code
                                        class="docutils literal notranslate"><span
                                        class="pre">zeus2_toolbox.pipeline</span></code> module, which already imports
                                all other modules of the package.</p>
                            <div class="cell docutils container">
                                <div class="cell_input docutils container">
                                    <div class="highlight-ipython3 notranslate">
                                        <div class="highlight"><pre><span></span><span class="kn">from</span> <span
                                                class="nn">zeus2_toolbox</span> <span class="kn">import</span> <span
                                                class="n">pipeline</span> <span class="k">as</span> <span class="n">z2pipl</span>
</pre>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="cell docutils container">
                                <div class="cell_input docutils container">
                                    <div class="highlight-ipython3 notranslate">
                                        <div class="highlight"><pre><span></span><span class="kn">import</span> <span
                                                class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span
                                                    class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">Image</span>
</pre>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="section" id="data-reduction-on-science-target">
                                <h2>Data reduction on science target<a class="headerlink"
                                                                       href="#data-reduction-on-science-target"
                                                                       title="Permalink to this headline">¶</a></h2>
                                <p>Let’s start with the most useful part, which is to reduce some actual data. The first
                                    example is to reduce PLCK G244 data taken on 2019/11/28, beam number 0 ~ 39. We
                                    begin with loading the array map corresponding to the observation setup.</p>
                                <div class="cell docutils container">
                                    <div class="cell_input docutils container">
                                        <div class="highlight-ipython3 notranslate">
                                            <div class="highlight"><pre><span></span><span
                                                    class="n">array_map</span> <span class="o">=</span> <span class="n">z2pipl</span><span
                                                    class="o">.</span><span class="n">ArrayMap</span><span
                                                    class="o">.</span><span class="n">read</span><span
                                                    class="p">(</span><span class="s2">&quot;/data2/share/zeus-2/ref/array_map_excel_alternative_20211101.csv&quot;</span><span
                                                    class="p">)</span>
<span class="n">array_map</span><span class="o">.</span><span class="n">set_band</span><span class="p">(</span><span
                                                        class="mi">350</span><span class="p">)</span>
</pre>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <p>Optionally we can also load the observation log which contains lots of supplementary
                                    information of the observation. Otherwise set <code
                                            class="docutils literal notranslate"><span class="pre">obs_log</span> <span
                                            class="pre">=</span> <span class="pre">None</span></code>.</p>
                                <div class="cell docutils container">
                                    <div class="cell_input docutils container">
                                        <div class="highlight-ipython3 notranslate">
                                            <div class="highlight"><pre><span></span><span
                                                    class="n">obs_log</span> <span class="o">=</span> <span class="n">z2pipl</span><span
                                                    class="o">.</span><span class="n">ObsLog</span><span
                                                    class="o">.</span><span class="n">read_folder</span><span class="p">(</span><span
                                                    class="s2">&quot;/data2/share/zeus-2/all_apex_2019/apex_logs/obslogs&quot;</span><span
                                                    class="p">)</span>
</pre>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <p>Besides we will also define some handy variables controlling where to read our data
                                    from and where to write the result figure/table.</p>
                                <div class="cell docutils container">
                                    <div class="cell_input docutils container">
                                        <div class="highlight-ipython3 notranslate">
                                            <div class="highlight"><pre><span></span><span
                                                    class="n">DATA_DIR</span> <span class="o">=</span> <span class="s2">&quot;/data2/share/zeus-2/all_apex_2019/20191128/&quot;</span>
<span class="n">WRITE_DIR</span> <span class="o">=</span> <span class="s2">&quot;/data/bp/workspace/zeus-2/nb/Plck_g244+54&quot;</span>
</pre>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <p>Now we can start actual data reduction. An observation often involves one or multiple
                                    flat field scans used as the normalization of the detector. After that, the science
                                    observation is taken by the command <code class="docutils literal notranslate"><span
                                            class="pre">zobs</span></code> which means nodding the telescope between the
                                    neighboring beams to subtract the flux due to telescope dish temperature gradient.
                                </p>
                                <p>We first need to get the flat field result in the file “skychop_191128_0068” and
                                    “skychop_191128_0069”. To do that we call <code
                                            class="docutils literal notranslate"><span
                                            class="pre">z2pipl.reduce_flat()</span></code> function with <code
                                            class="docutils literal notranslate"><span class="pre">flat_header={&quot;skychop_191128&quot;:</span>
                                        <span class="pre">[(68,</span> <span class="pre">69)]}</span></code>. The <code
                                            class="docutils literal notranslate"><span
                                            class="pre">flat_header</span></code> variable indicates the filename of the
                                    beams to process, it has the format as <code
                                            class="docutils literal notranslate"><span class="pre">dict{&quot;file_header1&quot;:</span>
                                        <span class="pre">[(start_beam_num1,</span> <span
                                                class="pre">end_beam_num1),</span> <span
                                                class="pre">(start_beam_num2,</span> <span
                                                class="pre">end_beam_num2),</span> <span class="pre">...],</span> <span
                                                class="pre">...}</span></code>. <code
                                            class="docutils literal notranslate"><span
                                            class="pre">flat_header</span></code> is designed this way to has the
                                    flexibility to combine beams of different file headers, or not continuous.</p>
                                <p>Because the line is placed at [1, 11], we would like to check the timeseries and the
                                    performance of the pixels in that region. Therefore we <code
                                            class="docutils literal notranslate"><span class="pre">REG_INTEREST={&quot;spat_ran&quot;:(0,2),</span>
                                        <span class="pre">&quot;spec_ran&quot;:(9,13)}</span></code> so that the
                                    function would plot the time series, beam and beam pair flux of the pixels in the
                                    spatial position 0 through 2, spectral index 9 through 13. There are many ways to
                                    set <code class="docutils literal notranslate"><span class="pre">REG_INTEREST</span></code>
                                    to control the pixels you would like to plot. The variable <code
                                            class="docutils literal notranslate"><span
                                            class="pre">ref_interest</span></code> is passed to <code
                                            class="docutils literal notranslate"><span
                                            class="pre">ArrayMap.take_where()</span></code> as <code
                                            class="docutils literal notranslate"><span class="pre">kwargs</span></code>,
                                    please refer to the document for more information.</p>
                                <div class="cell docutils container">
                                    <div class="cell_input docutils container">
                                        <div class="highlight-ipython3 notranslate">
                                            <div class="highlight"><pre><span></span><span class="n">FLAT_HEADER</span> <span
                                                    class="o">=</span> <span class="p">{</span><span class="s2">&quot;skychop_191128&quot;</span><span
                                                    class="p">:</span> <span class="p">[(</span><span
                                                    class="mi">68</span><span class="p">,</span> <span
                                                    class="mi">69</span><span class="p">)]}</span>
<span class="n">REG_INTEREST</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;spat_ran&quot;</span><span
                                                        class="p">:(</span><span class="mi">0</span><span
                                                        class="p">,</span> <span class="mi">2</span><span
                                                        class="p">),</span> <span class="s2">&quot;spec_ran&quot;</span><span
                                                        class="p">:(</span><span class="mi">9</span><span
                                                        class="p">,</span><span class="mi">13</span><span
                                                        class="p">)}</span>
</pre>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="cell docutils container">
                                    <div class="cell_input docutils container">
                                        <div class="highlight-ipython3 notranslate">
                                            <div class="highlight"><pre><span></span><span class="n">flat_result</span> <span
                                                    class="o">=</span> <span class="n">z2pipl</span><span
                                                    class="o">.</span><span class="n">reduce_skychop</span><span
                                                    class="p">(</span>
    <span class="n">flat_header</span><span class="o">=</span><span class="n">FLAT_HEADER</span><span class="p">,</span> <span
                                                        class="n">data_dir</span><span class="o">=</span><span
                                                        class="n">DATA_DIR</span><span class="p">,</span> <span
                                                        class="n">write_dir</span><span class="o">=</span><span
                                                        class="n">WRITE_DIR</span><span class="p">,</span>
    <span class="n">array_map</span><span class="o">=</span><span class="n">array_map</span><span
                                                        class="p">,</span> <span class="n">obs_log</span><span
                                                        class="o">=</span><span class="n">obs_log</span><span class="p">,</span> <span
                                                        class="n">parallel</span><span class="o">=</span><span
                                                        class="kc">True</span><span class="p">,</span> <span class="n">return_pix_flag_list</span><span
                                                        class="o">=</span><span class="kc">True</span><span
                                                        class="p">,</span> <span class="n">table_save</span><span
                                                        class="o">=</span><span class="kc">True</span><span
                                                        class="p">,</span>
    <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span
                                                        class="n">plot_ts</span><span class="o">=</span><span
                                                        class="kc">True</span><span class="p">,</span> <span class="n">reg_interest</span><span
                                                        class="o">=</span><span class="n">REG_INTEREST</span><span
                                                        class="p">,</span>
    <span class="n">plot_flux</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span
                                                        class="n">plot_show</span><span class="o">=</span><span
                                                        class="kc">False</span><span class="p">,</span> <span class="n">plot_save</span><span
                                                        class="o">=</span><span class="kc">True</span><span
                                                        class="p">)</span>
<span class="n">flat_flux</span><span class="p">,</span> <span class="n">flat_err</span><span class="p">,</span> <span
                                                        class="n">pix_flag_list</span> <span class="o">=</span> <span
                                                        class="n">flat_result</span><span class="p">[:</span><span
                                                        class="mi">2</span><span class="p">]</span> <span
                                                        class="o">+</span> <span class="n">flat_result</span><span
                                                        class="p">[</span><span class="o">-</span><span
                                                        class="mi">1</span><span class="p">:]</span>
</pre>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="cell_output docutils container">
                                        <div class="output stream highlight-myst-ansi notranslate">
                                            <div class="highlight"><pre><span></span>Processing beam /data2/share/zeus-2/all_apex_2019/20191128/skychop_191128_0068.
Processing beam /data2/share/zeus-2/all_apex_2019/20191128/skychop_191128_0069.
</pre>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <p>Because I set <code class="docutils literal notranslate"><span class="pre">table_save=True,</span>
                                    <span class="pre">plot_show=False,</span> <span
                                            class="pre">plot_save=True</span></code>, the tables and figures containing
                                    the result can be checked in the set <code
                                            class="docutils literal notranslate"><span
                                            class="pre">WRITE_DIR</span></code>. It is not recommended to set <code
                                            class="docutils literal notranslate"><span class="pre">plot_show=True</span></code>
                                    as it would take extra time for jupyter to display the figure (minutes if the figure
                                    is big) and slow down the reduction process. We then proceed to the next step of
                                    reducing the science data. Following a similar logic, we call <code
                                            class="docutils literal notranslate"><span
                                            class="pre">z2pipl.reduce_zobs()</span></code> function with <code
                                            class="docutils literal notranslate"><span class="pre">data_header={&quot;plck_191128&quot;:</span>
                                        <span class="pre">[(0,</span> <span class="pre">39)]}</span></code> to reduce
                                    data stored in files “plck_191128_0000” through “plck_191128_0039”. And we only use
                                    “desnake” to reduce the long term noise in the timeseries. The line pixel [1, 11] is
                                    used as the reference pixel to select other good pixels, which are averaged together
                                    to build a high SNR snake model.</p>
                                <div class="cell docutils container">
                                    <div class="cell_input docutils container">
                                        <div class="highlight-ipython3 notranslate">
                                            <div class="highlight"><pre><span></span><span class="n">DATA_HEADER</span> <span
                                                    class="o">=</span> <span class="p">{</span><span class="s2">&quot;plck_191128&quot;</span><span
                                                    class="p">:</span> <span class="p">[(</span><span
                                                    class="mi">0</span><span class="p">,</span> <span
                                                    class="mi">39</span><span class="p">)]}</span>
<span class="n">REF_PIX</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span
                                                        class="p">,</span> <span class="mi">11</span><span
                                                        class="p">]</span>
</pre>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="cell docutils container">
                                    <div class="cell_input docutils container">
                                        <div class="highlight-ipython3 notranslate">
                                            <div class="highlight"><pre><span></span><span class="n">zobs_result</span> <span
                                                    class="o">=</span> <span class="n">z2pipl</span><span
                                                    class="o">.</span><span class="n">reduce_zobs</span><span class="p">(</span>
    <span class="n">data_header</span><span class="o">=</span><span class="n">DATA_HEADER</span><span class="p">,</span> <span
                                                        class="n">data_dir</span><span class="o">=</span><span
                                                        class="n">DATA_DIR</span><span class="p">,</span> <span
                                                        class="n">write_dir</span><span class="o">=</span><span
                                                        class="n">WRITE_DIR</span><span class="p">,</span>
    <span class="n">array_map</span><span class="o">=</span><span class="n">array_map</span><span
                                                        class="p">,</span> <span class="n">obs_log</span><span
                                                        class="o">=</span><span class="n">obs_log</span><span class="p">,</span> <span
                                                        class="n">pix_flag_list</span><span class="o">=</span><span
                                                        class="n">pix_flag_list</span><span class="p">,</span>
    <span class="n">flat_flux</span><span class="o">=</span><span class="n">flat_flux</span><span
                                                        class="p">,</span> <span class="n">flat_err</span><span
                                                        class="o">=</span><span class="n">flat_err</span><span
                                                        class="p">,</span> <span class="n">parallel</span><span
                                                        class="o">=</span><span class="kc">True</span><span
                                                        class="p">,</span> <span class="n">stack</span><span
                                                        class="o">=</span><span class="kc">False</span><span
                                                        class="p">,</span>
    <span class="n">do_desnake</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span
                                                        class="n">ref_pix</span><span class="o">=</span><span class="n">REF_PIX</span><span
                                                        class="p">,</span> <span class="n">do_smooth</span><span
                                                        class="o">=</span><span class="kc">False</span><span
                                                        class="p">,</span>
    <span class="n">do_ica</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span
                                                        class="n">spat_excl</span><span class="o">=</span><span
                                                        class="kc">None</span><span class="p">,</span> <span class="n">return_ts</span><span
                                                        class="o">=</span><span class="kc">False</span><span
                                                        class="p">,</span>
    <span class="n">return_pix_flag_list</span><span class="o">=</span><span class="kc">True</span><span
                                                        class="p">,</span> <span class="n">table_save</span><span
                                                        class="o">=</span><span class="kc">False</span><span
                                                        class="p">,</span> <span class="n">plot</span><span
                                                        class="o">=</span><span class="kc">True</span><span
                                                        class="p">,</span> <span class="n">plot_ts</span><span
                                                        class="o">=</span><span class="kc">True</span><span
                                                        class="p">,</span>
    <span class="n">reg_interest</span><span class="o">=</span><span class="n">REG_INTEREST</span><span
                                                        class="p">,</span> <span class="n">plot_flux</span><span
                                                        class="o">=</span><span class="kc">True</span><span
                                                        class="p">,</span>
    <span class="n">plot_show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span
                                                        class="n">plot_save</span><span class="o">=</span><span
                                                        class="kc">True</span><span class="p">)</span>
<span class="n">zobs_flux</span><span class="p">,</span> <span class="n">zobs_err</span><span class="p">,</span> <span
                                                        class="n">zobs_pix_flag_list</span> <span
                                                        class="o">=</span> <span class="n">zobs_result</span><span
                                                        class="p">[:</span><span class="mi">2</span><span
                                                        class="p">]</span> <span class="o">+</span> <span class="n">zobs_result</span><span
                                                        class="p">[</span><span class="o">-</span><span
                                                        class="mi">1</span><span class="p">:]</span>
</pre>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <p>Let’s check the spectrum of the observation</p>
                                <div class="cell docutils container">
                                    <div class="cell_input docutils container">
                                        <div class="highlight-ipython3 notranslate">
                                            <div class="highlight"><pre><span></span><span class="n">fig</span> <span
                                                    class="o">=</span> <span class="n">z2pipl</span><span
                                                    class="o">.</span><span class="n">FigSpec</span><span
                                                    class="o">.</span><span class="n">plot_spec</span><span
                                                    class="p">(</span><span class="n">zobs_flux</span><span
                                                    class="p">,</span> <span class="n">yerr</span><span
                                                    class="o">=</span><span class="n">zobs_err</span><span
                                                    class="p">,</span>
                               <span class="n">pix_flag_list</span><span class="o">=</span><span class="n">zobs_pix_flag_list</span><span
                                                        class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">plot_all_spat</span><span class="p">([</span><span
                                                        class="mi">0</span><span class="p">,</span> <span
                                                        class="mi">19</span><span class="p">],</span> <span
                                                        class="p">[</span><span class="mi">0</span><span
                                                        class="p">,</span> <span class="mi">0</span><span
                                                        class="p">],</span> <span class="n">ls</span><span
                                                        class="o">=</span><span class="s2">&quot;:&quot;</span><span
                                                        class="p">,</span> <span class="n">c</span><span
                                                        class="o">=</span><span class="s2">&quot;k&quot;</span><span
                                                        class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span
                                                        class="n">fig</span><span class="p">)</span>
</pre>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="cell_output docutils container">
                                        <img alt="../_images/pipeline_reduction_18_0.png"
                                             src="../_images/pipeline_reduction_18_0.png"/>
                                    </div>
                                </div>
                                <p>Now let’s try to use ICA decomposition to reduce the correlated noise. Remember to
                                    set <code class="docutils literal notranslate"><span
                                            class="pre">stack=True</span></code> to stack beams of opposite nodding
                                    phase to exclude flux due to temperature gradient. Also remember to set <code
                                            class="docutils literal notranslate"><span
                                            class="pre">spat_excl</span></code> as the spatial position excluded from
                                    ICA decomposition. In this case it is set to <code
                                            class="docutils literal notranslate"><span class="pre">[0,</span> <span
                                            class="pre">2]</span></code> as the potential spatial position of the
                                    target.</p>
                                <div class="cell docutils container">
                                    <div class="cell_input docutils container">
                                        <div class="highlight-ipython3 notranslate">
                                            <div class="highlight"><pre><span></span><span
                                                    class="n">SPAT_EXCL</span> <span class="o">=</span> <span class="p">[</span><span
                                                    class="mi">0</span><span class="p">,</span> <span
                                                    class="mi">2</span><span class="p">]</span>
</pre>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="cell docutils container">
                                    <div class="cell_input docutils container">
                                        <div class="highlight-ipython3 notranslate">
                                            <div class="highlight"><pre><span></span><span
                                                    class="n">zobs_ica_result</span> <span class="o">=</span> <span
                                                    class="n">z2pipl</span><span class="o">.</span><span class="n">reduce_zobs</span><span
                                                    class="p">(</span>
    <span class="n">data_header</span><span class="o">=</span><span class="n">DATA_HEADER</span><span class="p">,</span> <span
                                                        class="n">data_dir</span><span class="o">=</span><span
                                                        class="n">DATA_DIR</span><span class="p">,</span> <span
                                                        class="n">write_dir</span><span class="o">=</span><span
                                                        class="n">WRITE_DIR</span><span class="p">,</span>
    <span class="n">array_map</span><span class="o">=</span><span class="n">array_map</span><span
                                                        class="p">,</span> <span class="n">obs_log</span><span
                                                        class="o">=</span><span class="n">obs_log</span><span class="p">,</span> <span
                                                        class="n">pix_flag_list</span><span class="o">=</span><span
                                                        class="n">pix_flag_list</span><span class="p">,</span>
    <span class="n">flat_flux</span><span class="o">=</span><span class="n">flat_flux</span><span
                                                        class="p">,</span> <span class="n">flat_err</span><span
                                                        class="o">=</span><span class="n">flat_err</span><span
                                                        class="p">,</span> <span class="n">parallel</span><span
                                                        class="o">=</span><span class="kc">True</span><span
                                                        class="p">,</span> <span class="n">stack</span><span
                                                        class="o">=</span><span class="kc">True</span><span
                                                        class="p">,</span>
    <span class="n">do_desnake</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span
                                                        class="n">ref_pix</span><span class="o">=</span><span class="n">REF_PIX</span><span
                                                        class="p">,</span> <span class="n">do_smooth</span><span
                                                        class="o">=</span><span class="kc">False</span><span
                                                        class="p">,</span>
    <span class="n">do_ica</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span
                                                        class="n">spat_excl</span><span class="o">=</span><span
                                                        class="n">SPAT_EXCL</span><span class="p">,</span> <span
                                                        class="n">return_ts</span><span class="o">=</span><span
                                                        class="kc">False</span><span class="p">,</span>
    <span class="n">return_pix_flag_list</span><span class="o">=</span><span class="kc">True</span><span
                                                        class="p">,</span> <span class="n">table_save</span><span
                                                        class="o">=</span><span class="kc">False</span><span
                                                        class="p">,</span> <span class="n">plot</span><span
                                                        class="o">=</span><span class="kc">True</span><span
                                                        class="p">,</span> <span class="n">plot_ts</span><span
                                                        class="o">=</span><span class="kc">True</span><span
                                                        class="p">,</span>
    <span class="n">reg_interest</span><span class="o">=</span><span class="n">REG_INTEREST</span><span
                                                        class="p">,</span> <span class="n">plot_flux</span><span
                                                        class="o">=</span><span class="kc">True</span><span
                                                        class="p">,</span>
    <span class="n">plot_show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span
                                                        class="n">plot_save</span><span class="o">=</span><span
                                                        class="kc">True</span><span class="p">)</span>
<span class="n">zobs_ica_flux</span><span class="p">,</span> <span class="n">zobs_ica_err</span><span class="p">,</span> <span
                                                        class="n">zobs_ica_pix_flag_list</span> <span class="o">=</span> <span
                                                        class="n">zobs_ica_result</span><span class="p">[:</span><span
                                                        class="mi">2</span><span class="p">]</span> <span
                                                        class="o">+</span> <span class="n">zobs_ica_result</span><span
                                                        class="p">[</span><span class="o">-</span><span
                                                        class="mi">1</span><span class="p">:]</span>
</pre>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <p>We can compare with result of the two reductions.</p>
                                <div class="cell docutils container">
                                    <div class="cell_input docutils container">
                                        <div class="highlight-ipython3 notranslate">
                                            <div class="highlight"><pre><span></span><span class="n">fig</span> <span
                                                    class="o">=</span> <span class="n">z2pipl</span><span
                                                    class="o">.</span><span class="n">FigSpec</span><span
                                                    class="o">.</span><span class="n">plot_spec</span><span
                                                    class="p">(</span><span class="n">zobs_flux</span><span
                                                    class="p">,</span> <span class="n">yerr</span><span
                                                    class="o">=</span><span class="n">zobs_err</span><span
                                                    class="p">,</span>
                               <span class="n">pix_flag_list</span><span class="o">=</span><span class="n">zobs_pix_flag_list</span><span
                                                        class="p">,</span> <span class="n">label</span><span
                                                        class="o">=</span><span
                                                        class="s2">&quot;desnake&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">zobs_ica_flux</span><span
                                                        class="p">,</span> <span class="n">pix_flag_list</span><span
                                                        class="o">=</span><span class="n">zobs_pix_flag_list</span><span
                                                        class="p">,</span> <span class="n">c</span><span
                                                        class="o">=</span><span class="s2">&quot;k&quot;</span><span
                                                        class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span
                                                        class="n">zobs_ica_flux</span><span class="p">,</span> <span
                                                        class="n">yerr</span><span class="o">=</span><span class="n">zobs_ica_err</span><span
                                                        class="p">,</span> <span class="n">pix_flag_list</span><span
                                                        class="o">=</span><span class="n">zobs_pix_flag_list</span><span
                                                        class="p">,</span>
             <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span
                                                        class="p">,</span> <span class="n">label</span><span
                                                        class="o">=</span><span class="s2">&quot;ica&quot;</span><span
                                                        class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">plot_all_spat</span><span class="p">([</span><span
                                                        class="mi">0</span><span class="p">,</span> <span
                                                        class="mi">19</span><span class="p">],</span> <span
                                                        class="p">[</span><span class="mi">0</span><span
                                                        class="p">,</span> <span class="mi">0</span><span
                                                        class="p">],</span> <span class="n">ls</span><span
                                                        class="o">=</span><span class="s2">&quot;:&quot;</span><span
                                                        class="p">,</span> <span class="n">color</span><span
                                                        class="o">=</span><span class="s2">&quot;k&quot;</span><span
                                                        class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span
                                                        class="n">fig</span><span class="p">)</span>
</pre>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="cell_output docutils container">
                                        <img alt="../_images/pipeline_reduction_23_0.png"
                                             src="../_images/pipeline_reduction_23_0.png"/>
                                    </div>
                                </div>
                                <p>The flux of each beam pair (black) and the convergence of cumulative flux (cyan) is
                                    presented in the “{header}_beam_pairs_flux.png”. The black data point with errorbar
                                    represents the flux of pixel in each beam pair, with the cyan point showing the
                                    cumulative flux throughout the integration. The value of the data points are in the
                                    y-axis on the left side. The red dash line corresponding to the right y-axis is the
                                    PWV along the time.</p>
                                <div class="cell docutils container">
                                    <div class="cell_input docutils container">
                                        <div class="highlight-ipython3 notranslate">
                                            <div class="highlight"><pre><span></span><span class="n">Image</span><span
                                                    class="p">(</span><span class="n">os</span><span
                                                    class="o">.</span><span class="n">path</span><span
                                                    class="o">.</span><span class="n">join</span><span
                                                    class="p">(</span><span class="n">WRITE_DIR</span><span
                                                    class="p">,</span> <span class="s2">&quot;plck_191128_0000-0039_beam_pairs_flux.png&quot;</span><span
                                                    class="p">))</span>
</pre>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="cell_output docutils container">
                                        <img alt="../_images/pipeline_reduction_25_0.png"
                                             src="../_images/pipeline_reduction_25_0.png"/>
                                    </div>
                                </div>
                                <p>For the convenience I show another example with a single block of code that reduces
                                    w0533_191130_0084-0143 with ICA. I will not read array map or observation log
                                    again.</p>
                                <div class="cell docutils container">
                                    <div class="cell_input docutils container">
                                        <div class="highlight-ipython3 notranslate">
                                            <div class="highlight"><pre><span></span><span
                                                    class="n">DATA_DIR</span> <span class="o">=</span> <span class="s2">&quot;/data2/share/zeus-2/all_apex_2019/20191130/&quot;</span>
<span class="n">WRITE_DIR</span> <span class="o">=</span> <span class="s2">&quot;/data/bp/workspace/zeus-2/nb/W0533-3401&quot;</span>

<span class="n">FLAT_HEADER</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;skychop_191130&quot;</span><span
                                                        class="p">:</span> <span class="p">[(</span><span
                                                        class="mi">24</span><span class="p">,</span> <span
                                                        class="mi">26</span><span class="p">)]}</span>
<span class="n">DATA_HEADER</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;w0533_191130&quot;</span><span
                                                        class="p">:</span> <span class="p">[(</span><span
                                                        class="mi">84</span><span class="p">,</span> <span class="mi">143</span><span
                                                        class="p">)]}</span>

<span class="c1"># reduction method</span>
<span class="n">DO_DESNAKE</span><span class="p">,</span> <span class="n">REF_PIX</span> <span class="o">=</span> <span
                                                        class="kc">False</span><span class="p">,</span> <span
                                                        class="kc">None</span>
<span class="n">DO_SMOOTH</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">DO_ICA</span><span class="p">,</span> <span class="n">SPAT_EXCL</span> <span class="o">=</span> <span
                                                        class="kc">True</span><span class="p">,</span> <span
                                                        class="p">[</span><span class="mi">0</span><span
                                                        class="p">,</span> <span class="mi">2</span><span
                                                        class="p">]</span>

<span class="c1"># flag</span>
<span class="n">PARALLEL</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">TABLE_SAVE</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">PLOT</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">PLOT_TS</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">REG_INTEREST</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;spat_ran&quot;</span><span
                                                        class="p">:(</span><span class="mi">0</span><span
                                                        class="p">,</span> <span class="mi">2</span><span
                                                        class="p">),</span> <span class="s2">&quot;spec_ran&quot;</span><span
                                                        class="p">:(</span><span class="mi">5</span><span
                                                        class="p">,</span> <span class="mi">9</span><span
                                                        class="p">)}</span> <span
                                                        class="c1"># line is placed at [1, 7]</span>
<span class="n">PLOT_FLUX</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">PLOT_SHOW</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">PLOT_SAVE</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># reduce flat</span>
<span class="n">flat_result</span> <span class="o">=</span> <span class="n">z2pipl</span><span class="o">.</span><span
                                                        class="n">reduce_skychop</span><span class="p">(</span>
    <span class="n">flat_header</span><span class="o">=</span><span class="n">FLAT_HEADER</span><span class="p">,</span> <span
                                                        class="n">data_dir</span><span class="o">=</span><span
                                                        class="n">DATA_DIR</span><span class="p">,</span> <span
                                                        class="n">write_dir</span><span class="o">=</span><span
                                                        class="n">WRITE_DIR</span><span class="p">,</span>
    <span class="n">array_map</span><span class="o">=</span><span class="n">array_map</span><span
                                                        class="p">,</span> <span class="n">obs_log</span><span
                                                        class="o">=</span><span class="n">obs_log</span><span class="p">,</span> <span
                                                        class="n">parallel</span><span class="o">=</span><span
                                                        class="n">PARALLEL</span><span class="p">,</span>
    <span class="n">table_save</span><span class="o">=</span><span class="n">TABLE_SAVE</span><span
                                                        class="p">,</span> <span class="n">plot</span><span
                                                        class="o">=</span><span class="n">PLOT</span><span
                                                        class="p">,</span> <span class="n">plot_ts</span><span
                                                        class="o">=</span><span class="n">PLOT_TS</span><span class="p">,</span> <span
                                                        class="n">reg_interest</span><span class="o">=</span><span
                                                        class="n">REG_INTEREST</span><span class="p">,</span>
    <span class="n">plot_flux</span><span class="o">=</span><span class="n">PLOT_FLUX</span><span
                                                        class="p">,</span> <span class="n">plot_show</span><span
                                                        class="o">=</span><span class="n">PLOT_SHOW</span><span
                                                        class="p">,</span> <span class="n">plot_save</span><span
                                                        class="o">=</span><span class="n">PLOT_SAVE</span><span
                                                        class="p">)</span>
<span class="n">flat_flux</span><span class="p">,</span> <span class="n">flat_err</span><span class="p">,</span> <span
                                                        class="n">pix_flag_list</span> <span class="o">=</span> <span
                                                        class="n">flat_result</span><span class="p">[:</span><span
                                                        class="mi">2</span><span class="p">]</span> <span
                                                        class="o">+</span> <span class="n">flat_result</span><span
                                                        class="p">[</span><span class="o">-</span><span
                                                        class="mi">1</span><span class="p">:]</span>

<span class="c1"># reduce zobs</span>
<span class="n">zobs_ica_result</span> <span class="o">=</span> <span class="n">z2pipl</span><span
                                                        class="o">.</span><span class="n">reduce_zobs</span><span
                                                        class="p">(</span>
    <span class="n">data_header</span><span class="o">=</span><span class="n">DATA_HEADER</span><span class="p">,</span> <span
                                                        class="n">data_dir</span><span class="o">=</span><span
                                                        class="n">DATA_DIR</span><span class="p">,</span> <span
                                                        class="n">write_dir</span><span class="o">=</span><span
                                                        class="n">WRITE_DIR</span><span class="p">,</span>
    <span class="n">array_map</span><span class="o">=</span><span class="n">array_map</span><span
                                                        class="p">,</span> <span class="n">obs_log</span><span
                                                        class="o">=</span><span class="n">obs_log</span><span class="p">,</span> <span
                                                        class="n">pix_flag_list</span><span class="o">=</span><span
                                                        class="n">pix_flag_list</span><span class="p">,</span>
    <span class="n">flat_flux</span><span class="o">=</span><span class="n">flat_flux</span><span
                                                        class="p">,</span> <span class="n">flat_err</span><span
                                                        class="o">=</span><span class="n">flat_err</span><span
                                                        class="p">,</span> <span class="n">parallel</span><span
                                                        class="o">=</span><span class="n">PARALLEL</span><span
                                                        class="p">,</span> <span class="n">stack</span><span
                                                        class="o">=</span><span class="n">DO_ICA</span><span
                                                        class="p">,</span>
    <span class="n">do_desnake</span><span class="o">=</span><span class="n">DO_DESNAKE</span><span
                                                        class="p">,</span> <span class="n">ref_pix</span><span
                                                        class="o">=</span><span class="n">REF_PIX</span><span class="p">,</span> <span
                                                        class="n">do_smooth</span><span class="o">=</span><span
                                                        class="n">DO_SMOOTH</span><span class="p">,</span>
    <span class="n">do_ica</span><span class="o">=</span><span class="n">DO_ICA</span><span class="p">,</span> <span
                                                        class="n">spat_excl</span><span class="o">=</span><span
                                                        class="n">SPAT_EXCL</span><span class="p">,</span> <span
                                                        class="n">return_pix_flag_list</span><span
                                                        class="o">=</span><span class="kc">True</span><span
                                                        class="p">,</span>
    <span class="n">table_save</span><span class="o">=</span><span class="n">TABLE_SAVE</span><span
                                                        class="p">,</span> <span class="n">plot</span><span
                                                        class="o">=</span><span class="n">PLOT</span><span
                                                        class="p">,</span> <span class="n">plot_ts</span><span
                                                        class="o">=</span><span class="n">PLOT_TS</span><span class="p">,</span>
    <span class="n">reg_interest</span><span class="o">=</span><span class="n">REG_INTEREST</span><span
                                                        class="p">,</span> <span class="n">plot_flux</span><span
                                                        class="o">=</span><span class="n">PLOT_FLUX</span><span
                                                        class="p">,</span>
    <span class="n">plot_show</span><span class="o">=</span><span class="n">PLOT_SHOW</span><span
                                                        class="p">,</span> <span class="n">plot_save</span><span
                                                        class="o">=</span><span class="n">PLOT_SAVE</span><span
                                                        class="p">)</span>
<span class="n">zobs_ica_flux</span><span class="p">,</span> <span class="n">zobs_ica_err</span><span class="p">,</span> <span
                                                        class="n">zobs_ica_pix_flag_list</span> <span class="o">=</span> <span
                                                        class="n">zobs_ica_result</span><span class="p">[:</span><span
                                                        class="mi">2</span><span class="p">]</span> <span
                                                        class="o">+</span> <span class="n">zobs_ica_result</span><span
                                                        class="p">[</span><span class="o">-</span><span
                                                        class="mi">1</span><span class="p">:]</span>
</pre>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="cell docutils container">
                                    <div class="cell_input docutils container">
                                        <div class="highlight-ipython3 notranslate">
                                            <div class="highlight"><pre><span></span><span class="n">Image</span><span
                                                    class="p">(</span><span class="n">os</span><span
                                                    class="o">.</span><span class="n">path</span><span
                                                    class="o">.</span><span class="n">join</span><span
                                                    class="p">(</span><span class="n">WRITE_DIR</span><span
                                                    class="p">,</span> <span class="s2">&quot;</span><span
                                                    class="si">%s</span><span class="s2">_spec.png&quot;</span> <span
                                                    class="o">%</span> <span class="n">z2pipl</span><span
                                                    class="o">.</span><span class="n">build_header</span><span
                                                    class="p">(</span><span class="n">DATA_HEADER</span><span class="p">)))</span>
</pre>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="cell_output docutils container">
                                        <img alt="../_images/pipeline_reduction_28_0.png"
                                             src="../_images/pipeline_reduction_28_0.png"/>
                                    </div>
                                </div>
                                <div class="cell docutils container">
                                    <div class="cell_input docutils container">
                                        <div class="highlight-ipython3 notranslate">
                                            <div class="highlight"><pre><span></span><span class="n">Image</span><span
                                                    class="p">(</span><span class="n">os</span><span
                                                    class="o">.</span><span class="n">path</span><span
                                                    class="o">.</span><span class="n">join</span><span
                                                    class="p">(</span><span class="n">WRITE_DIR</span><span
                                                    class="p">,</span> <span class="s2">&quot;</span><span
                                                    class="si">%s</span><span
                                                    class="s2">_beam_pairs_flux.png&quot;</span> <span
                                                    class="o">%</span> <span class="n">z2pipl</span><span
                                                    class="o">.</span><span class="n">build_header</span><span
                                                    class="p">(</span><span class="n">DATA_HEADER</span><span class="p">)))</span>
</pre>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="cell_output docutils container">
                                        <img alt="../_images/pipeline_reduction_29_0.png"
                                             src="../_images/pipeline_reduction_29_0.png"/>
                                    </div>
                                </div>
                            </div>
                            <div class="section" id="data-reduction-on-calibration-source">
                                <h2>Data reduction on calibration source<a class="headerlink"
                                                                           href="#data-reduction-on-calibration-source"
                                                                           title="Permalink to this headline">¶</a></h2>
                                <p>All observations taken with the commands other than <code
                                        class="docutils literal notranslate"><span class="pre">zobs</span></code>, <code
                                        class="docutils literal notranslate"><span class="pre">zpold</span></code> and
                                    <code class="docutils literal notranslate"><span class="pre">zpoldbig</span></code>
                                    are just continuous beams without nodding or special ordering. Most of the
                                    information is in the flux variation in different beams. Here for example, let’s
                                    reduce uranus_191128 beam 26 through 36, which is an <code
                                            class="docutils literal notranslate"><span class="pre">zpoint</span></code>
                                    observation for that night. Because this scan doesn’t have a skychop, we will skip
                                    the flat reduction step and leave the default value for flat, which are <code
                                            class="docutils literal notranslate"><span
                                            class="pre">flat_flux=1</span></code> and <code
                                            class="docutils literal notranslate"><span
                                            class="pre">flat_err=0</span></code>. Because the line is put at [1, 6], we
                                    would like to plot the spatial range [0, 2] and spectral range [5, 9].</p>
                                <div class="cell docutils container">
                                    <div class="cell_input docutils container">
                                        <div class="highlight-ipython3 notranslate">
                                            <div class="highlight"><pre><span></span><span
                                                    class="n">DATA_DIR</span> <span class="o">=</span> <span class="s2">&quot;/data2/share/zeus-2/all_apex_2019/20191128/&quot;</span>

<span class="n">DATA_HEADER</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;skychop_191128&quot;</span><span
                                                        class="p">:</span> <span class="p">[(</span><span
                                                        class="mi">26</span><span class="p">,</span> <span
                                                        class="mi">36</span><span class="p">)]}</span>

<span class="c1"># reduction method</span>
<span class="n">DO_DESNAKE</span><span class="p">,</span> <span class="n">REF_PIX</span> <span class="o">=</span> <span
                                                        class="kc">False</span><span class="p">,</span> <span
                                                        class="kc">None</span>
<span class="n">DO_SMOOTH</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">DO_ICA</span><span class="p">,</span> <span class="n">SPAT_EXCL</span> <span class="o">=</span> <span
                                                        class="kc">False</span><span class="p">,</span> <span
                                                        class="kc">None</span>

<span class="c1"># flag</span>
<span class="n">PARALLEL</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">TABLE_SAVE</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">PLOT</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">PLOT_TS</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">REG_INTEREST</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;spat_ran&quot;</span><span
                                                        class="p">:(</span><span class="mi">0</span><span
                                                        class="p">,</span> <span class="mi">2</span><span
                                                        class="p">),</span> <span class="s2">&quot;spec_ran&quot;</span><span
                                                        class="p">:(</span><span class="mi">5</span><span
                                                        class="p">,</span> <span class="mi">9</span><span
                                                        class="p">)}</span> <span
                                                        class="c1"># line is placed at [1, 6]</span>
<span class="n">PLOT_FLUX</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">PLOT_SHOW</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">PLOT_SAVE</span> <span class="o">=</span> <span class="kc">True</span>

<span class="n">flat_flux</span><span class="p">,</span> <span class="n">flat_err</span> <span class="o">=</span> <span
                                                        class="mi">1</span><span class="p">,</span> <span
                                                        class="mi">0</span>

<span class="c1"># reduce zobs</span>
<span class="n">zpoint_result</span> <span class="o">=</span> <span class="n">z2pipl</span><span class="o">.</span><span
                                                        class="n">reduce_calibration</span><span class="p">(</span>
    <span class="n">data_header</span><span class="o">=</span><span class="n">DATA_HEADER</span><span class="p">,</span> <span
                                                        class="n">data_dir</span><span class="o">=</span><span
                                                        class="n">DATA_DIR</span><span class="p">,</span> <span
                                                        class="n">write_dir</span><span class="o">=</span><span
                                                        class="n">WRITE_DIR</span><span class="p">,</span>
    <span class="n">array_map</span><span class="o">=</span><span class="n">array_map</span><span
                                                        class="p">,</span> <span class="n">obs_log</span><span
                                                        class="o">=</span><span class="n">obs_log</span><span class="p">,</span> <span
                                                        class="n">pix_flag_list</span><span class="o">=</span><span
                                                        class="p">[],</span>
    <span class="n">flat_flux</span><span class="o">=</span><span class="n">flat_flux</span><span
                                                        class="p">,</span> <span class="n">flat_err</span><span
                                                        class="o">=</span><span class="n">flat_err</span><span
                                                        class="p">,</span> <span class="n">parallel</span><span
                                                        class="o">=</span><span class="n">PARALLEL</span><span
                                                        class="p">,</span>
    <span class="n">do_desnake</span><span class="o">=</span><span class="n">DO_DESNAKE</span><span
                                                        class="p">,</span> <span class="n">ref_pix</span><span
                                                        class="o">=</span><span class="n">REF_PIX</span><span class="p">,</span> <span
                                                        class="n">do_smooth</span><span class="o">=</span><span
                                                        class="n">DO_SMOOTH</span><span class="p">,</span>
    <span class="n">do_ica</span><span class="o">=</span><span class="n">DO_ICA</span><span class="p">,</span> <span
                                                        class="n">spat_excl</span><span class="o">=</span><span
                                                        class="n">SPAT_EXCL</span><span class="p">,</span> <span
                                                        class="n">return_pix_flag_list</span><span
                                                        class="o">=</span><span class="kc">True</span><span
                                                        class="p">,</span>
    <span class="n">table_save</span><span class="o">=</span><span class="n">TABLE_SAVE</span><span
                                                        class="p">,</span> <span class="n">plot</span><span
                                                        class="o">=</span><span class="n">PLOT</span><span
                                                        class="p">,</span> <span class="n">plot_ts</span><span
                                                        class="o">=</span><span class="n">PLOT_TS</span><span class="p">,</span>
    <span class="n">reg_interest</span><span class="o">=</span><span class="n">REG_INTEREST</span><span
                                                        class="p">,</span> <span class="n">plot_flux</span><span
                                                        class="o">=</span><span class="n">PLOT_FLUX</span><span
                                                        class="p">,</span>
    <span class="n">plot_show</span><span class="o">=</span><span class="n">PLOT_SHOW</span><span
                                                        class="p">,</span> <span class="n">plot_save</span><span
                                                        class="o">=</span><span class="n">PLOT_SAVE</span><span
                                                        class="p">)</span>
<span class="n">zpoint_flux</span><span class="p">,</span> <span class="n">zpoint_err</span><span
                                                        class="p">,</span> <span
                                                        class="n">zpoint_pix_flag_list</span> <span
                                                        class="o">=</span> <span class="n">zpoint_result</span><span
                                                        class="p">[:</span><span class="mi">2</span><span
                                                        class="p">]</span> <span class="o">+</span> <span class="n">zpoint_result</span><span
                                                        class="p">[</span><span class="o">-</span><span
                                                        class="mi">1</span><span class="p">:]</span>
</pre>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <p>The figure below shows the pixel flux of each beam in the raw data unit due to the
                                    lack of skychop.</p>
                                <div class="cell docutils container">
                                    <div class="cell_input docutils container">
                                        <div class="highlight-ipython3 notranslate">
                                            <div class="highlight"><pre><span></span><span class="n">Image</span><span
                                                    class="p">(</span><span class="n">os</span><span
                                                    class="o">.</span><span class="n">path</span><span
                                                    class="o">.</span><span class="n">join</span><span
                                                    class="p">(</span><span class="n">WRITE_DIR</span><span
                                                    class="p">,</span> <span class="s2">&quot;</span><span
                                                    class="si">%s</span><span
                                                    class="s2">_beams_flux.png&quot;</span> <span
                                                    class="o">%</span> <span class="n">z2pipl</span><span
                                                    class="o">.</span><span class="n">build_header</span><span
                                                    class="p">(</span><span class="n">DATA_HEADER</span><span class="p">)))</span>
</pre>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="cell_output docutils container">
                                        <img alt="../_images/pipeline_reduction_34_0.png"
                                             src="../_images/pipeline_reduction_34_0.png"/>
                                    </div>
                                </div>
                            </div>
                            <div class="section" id="reduction-of-zpold-or-zpoldbig-raster">
                                <h2>Reduction of zpold or zpoldbig raster<a class="headerlink"
                                                                            href="#reduction-of-zpold-or-zpoldbig-raster"
                                                                            title="Permalink to this headline">¶</a>
                                </h2>
                                <p>For the purpose of checking focus/pointing quality, a raster of 3x3 or 5x5 size is
                                    taken by observing 9 or 25 beams while moving the telescope. The raster starts on
                                    the lower left corner, scanning horizontally to the right, then zigzaging upwards.
                                    The <code class="docutils literal notranslate"><span
                                            class="pre">reduce_zpold()</span></code> and <code
                                            class="docutils literal notranslate"><span
                                            class="pre">reduce_zpoldbig()</span></code> functions are developed to
                                    reduce these data and produce a figure representing the raster seen by each pixel.
                                </p>
                                <p>As an example, I will show uranus_191126_0025 to 0049 taken with <code
                                        class="docutils literal notranslate"><span class="pre">zpoldbig</span></code>.
                                    The flat is skychop_191126 260 through 262. I would like to see the raster on the
                                    whole 400 micron array, so I will read in the aray map again with the band set to
                                    400 instead of 350.</p>
                                <div class="cell docutils container">
                                    <div class="cell_input docutils container">
                                        <div class="highlight-ipython3 notranslate">
                                            <div class="highlight"><pre><span></span><span
                                                    class="n">array_map</span> <span class="o">=</span> <span class="n">z2pipl</span><span
                                                    class="o">.</span><span class="n">ArrayMap</span><span
                                                    class="o">.</span><span class="n">read</span><span
                                                    class="p">(</span><span class="s2">&quot;/data2/share/zeus-2/ref/array_map_excel_alternative_20211101.csv&quot;</span><span
                                                    class="p">)</span>
<span class="n">array_map</span><span class="o">.</span><span class="n">set_band</span><span class="p">(</span><span
                                                        class="mi">400</span><span class="p">)</span>
</pre>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="cell docutils container">
                                    <div class="cell_input docutils container">
                                        <div class="highlight-ipython3 notranslate">
                                            <div class="highlight"><pre><span></span><span
                                                    class="n">DATA_DIR</span> <span class="o">=</span> <span class="s2">&quot;/data2/share/zeus-2/all_apex_2019/20191126&quot;</span>
<span class="n">WRITE_DIR</span> <span class="o">=</span> <span class="s2">&quot;/data/bp/workspace/zeus-2/nb/Uranus&quot;</span>

<span class="n">FLAT_HEADER</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;skychop_191126&quot;</span><span
                                                        class="p">:</span> <span class="p">[(</span><span
                                                        class="mi">260</span><span class="p">,</span> <span class="mi">262</span><span
                                                        class="p">)]}</span>
<span class="n">DATA_HEADER</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;uranus_191126&quot;</span><span
                                                        class="p">:</span> <span class="p">[(</span><span
                                                        class="mi">25</span><span class="p">,</span> <span
                                                        class="mi">49</span><span class="p">)]}</span>

<span class="c1"># reduction method</span>
<span class="n">DO_DESNAKE</span><span class="p">,</span> <span class="n">REF_PIX</span> <span class="o">=</span> <span
                                                        class="kc">False</span><span class="p">,</span> <span
                                                        class="kc">None</span>
<span class="n">DO_SMOOTH</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">DO_ICA</span><span class="p">,</span> <span class="n">SPAT_EXCL</span> <span class="o">=</span> <span
                                                        class="kc">False</span><span class="p">,</span> <span
                                                        class="kc">None</span>

<span class="c1"># flag</span>
<span class="n">PARALLEL</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">TABLE_SAVE</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">PLOT</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">PLOT_TS</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># pltting the time series of all the pixels can be very slow</span>
<span class="n">REG_INTEREST</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># show the whole array</span>
<span class="n">PLOT_FLUX</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">PLOT_SHOW</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">PLOT_SAVE</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># reduce flat</span>
<span class="n">flat_result</span> <span class="o">=</span> <span class="n">z2pipl</span><span class="o">.</span><span
                                                        class="n">reduce_skychop</span><span class="p">(</span>
    <span class="n">flat_header</span><span class="o">=</span><span class="n">FLAT_HEADER</span><span class="p">,</span> <span
                                                        class="n">data_dir</span><span class="o">=</span><span
                                                        class="n">DATA_DIR</span><span class="p">,</span> <span
                                                        class="n">write_dir</span><span class="o">=</span><span
                                                        class="n">WRITE_DIR</span><span class="p">,</span>
    <span class="n">array_map</span><span class="o">=</span><span class="n">array_map</span><span
                                                        class="p">,</span> <span class="n">obs_log</span><span
                                                        class="o">=</span><span class="n">obs_log</span><span class="p">,</span> <span
                                                        class="n">parallel</span><span class="o">=</span><span
                                                        class="n">PARALLEL</span><span class="p">,</span>
    <span class="n">table_save</span><span class="o">=</span><span class="n">TABLE_SAVE</span><span
                                                        class="p">,</span> <span class="n">plot</span><span
                                                        class="o">=</span><span class="n">PLOT</span><span
                                                        class="p">,</span> <span class="n">plot_ts</span><span
                                                        class="o">=</span><span class="n">PLOT_TS</span><span class="p">,</span> <span
                                                        class="n">reg_interest</span><span class="o">=</span><span
                                                        class="n">REG_INTEREST</span><span class="p">,</span>
    <span class="n">plot_flux</span><span class="o">=</span><span class="n">PLOT_FLUX</span><span
                                                        class="p">,</span> <span class="n">plot_show</span><span
                                                        class="o">=</span><span class="n">PLOT_SHOW</span><span
                                                        class="p">,</span> <span class="n">plot_save</span><span
                                                        class="o">=</span><span class="n">PLOT_SAVE</span><span
                                                        class="p">)</span>
<span class="n">flat_flux</span><span class="p">,</span> <span class="n">flat_err</span><span class="p">,</span> <span
                                                        class="n">pix_flag_list</span> <span class="o">=</span> <span
                                                        class="n">flat_result</span><span class="p">[:</span><span
                                                        class="mi">2</span><span class="p">]</span> <span
                                                        class="o">+</span> <span class="n">flat_result</span><span
                                                        class="p">[</span><span class="o">-</span><span
                                                        class="mi">1</span><span class="p">:]</span>

<span class="c1"># reduce zobs</span>
<span class="n">zpoldbig_result</span> <span class="o">=</span> <span class="n">z2pipl</span><span
                                                        class="o">.</span><span class="n">reduce_zpoldbig</span><span
                                                        class="p">(</span>
    <span class="n">data_header</span><span class="o">=</span><span class="n">DATA_HEADER</span><span class="p">,</span> <span
                                                        class="n">data_dir</span><span class="o">=</span><span
                                                        class="n">DATA_DIR</span><span class="p">,</span> <span
                                                        class="n">write_dir</span><span class="o">=</span><span
                                                        class="n">WRITE_DIR</span><span class="p">,</span>
    <span class="n">array_map</span><span class="o">=</span><span class="n">array_map</span><span
                                                        class="p">,</span> <span class="n">obs_log</span><span
                                                        class="o">=</span><span class="n">obs_log</span><span class="p">,</span> <span
                                                        class="n">pix_flag_list</span><span class="o">=</span><span
                                                        class="n">pix_flag_list</span><span class="p">,</span>
    <span class="n">flat_flux</span><span class="o">=</span><span class="n">flat_flux</span><span
                                                        class="p">,</span> <span class="n">flat_err</span><span
                                                        class="o">=</span><span class="n">flat_err</span><span
                                                        class="p">,</span> <span class="n">parallel</span><span
                                                        class="o">=</span><span class="n">PARALLEL</span><span
                                                        class="p">,</span>
    <span class="n">do_desnake</span><span class="o">=</span><span class="n">DO_DESNAKE</span><span
                                                        class="p">,</span> <span class="n">ref_pix</span><span
                                                        class="o">=</span><span class="n">REF_PIX</span><span class="p">,</span> <span
                                                        class="n">do_smooth</span><span class="o">=</span><span
                                                        class="n">DO_SMOOTH</span><span class="p">,</span>
    <span class="n">do_ica</span><span class="o">=</span><span class="n">DO_ICA</span><span class="p">,</span> <span
                                                        class="n">spat_excl</span><span class="o">=</span><span
                                                        class="n">SPAT_EXCL</span><span class="p">,</span> <span
                                                        class="n">return_pix_flag_list</span><span
                                                        class="o">=</span><span class="kc">True</span><span
                                                        class="p">,</span>
    <span class="n">table_save</span><span class="o">=</span><span class="n">TABLE_SAVE</span><span
                                                        class="p">,</span> <span class="n">plot</span><span
                                                        class="o">=</span><span class="n">PLOT</span><span
                                                        class="p">,</span> <span class="n">plot_ts</span><span
                                                        class="o">=</span><span class="n">PLOT_TS</span><span class="p">,</span>
    <span class="n">reg_interest</span><span class="o">=</span><span class="n">REG_INTEREST</span><span
                                                        class="p">,</span> <span class="n">plot_flux</span><span
                                                        class="o">=</span><span class="n">PLOT_FLUX</span><span
                                                        class="p">,</span>
    <span class="n">plot_show</span><span class="o">=</span><span class="n">PLOT_SHOW</span><span
                                                        class="p">,</span> <span class="n">plot_save</span><span
                                                        class="o">=</span><span class="n">PLOT_SAVE</span><span
                                                        class="p">)</span>
<span class="n">zpoldbig_flux</span><span class="p">,</span> <span class="n">zpoldbig_err</span><span class="p">,</span> <span
                                                        class="n">zpoldbig_pix_flag_list</span> <span class="o">=</span> <span
                                                        class="n">zpoldbig_result</span><span class="p">[:</span><span
                                                        class="mi">2</span><span class="p">]</span> <span
                                                        class="o">+</span> <span class="n">zpoldbig_result</span><span
                                                        class="p">[</span><span class="o">-</span><span
                                                        class="mi">1</span><span class="p">:]</span>
</pre>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <p>The result is saved in “{data_header}_raster.png”. In the figure, all the pixels
                                    without any 2-sigma detection in any beam are flagged. The pointing target Uranus
                                    clearly shows up as a point source at different location for pixels at different
                                    spatial position. It also shows the alignment of the array on the sky.</p>
                                <div class="cell docutils container">
                                    <div class="cell_input docutils container">
                                        <div class="highlight-ipython3 notranslate">
                                            <div class="highlight"><pre><span></span><span class="n">Image</span><span
                                                    class="p">(</span><span class="n">os</span><span
                                                    class="o">.</span><span class="n">path</span><span
                                                    class="o">.</span><span class="n">join</span><span
                                                    class="p">(</span><span class="n">WRITE_DIR</span><span
                                                    class="p">,</span> <span class="s2">&quot;</span><span
                                                    class="si">%s</span><span class="s2">_raster.png&quot;</span> <span
                                                    class="o">%</span> <span class="n">z2pipl</span><span
                                                    class="o">.</span><span class="n">build_header</span><span
                                                    class="p">(</span><span class="n">DATA_HEADER</span><span class="p">)))</span>
</pre>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="cell_output docutils container">
                                        <img alt="../_images/pipeline_reduction_40_0.png"
                                             src="../_images/pipeline_reduction_40_0.png"/>
                                    </div>
                                </div>
                            </div>
                        </div>


                    </div>


                    <!-- Previous / next buttons -->
                    <div class='prev-next-area'>
                        <a class='left-prev' href="../index.html" id="prev-link" title="previous page">
                            <i class="fas fa-angle-left"></i>
                            <div class="prev-next-info">
                                <p class="prev-next-subtitle">previous</p>
                                <p class="prev-next-title">zeus2_toolbox</p>
                            </div>
                        </a>
                        <a class='right-next' href="README.html" id="next-link" title="next page">
                            <div class="prev-next-info">
                                <p class="prev-next-subtitle">next</p>
                                <p class="prev-next-title">Documentation</p>
                            </div>
                            <i class="fas fa-angle-right"></i>
                        </a>
                    </div>

                </div>
            </div>
            <footer class="footer">
                <div class="container">
                    <p>

                        By Bo Peng<br/>

                        &copy; Copyright 2021, Bo Peng.<br/>
                    </p>
                </div>
            </footer>
        </main>


    </div>
</div>

<script src="../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

</body>
</html>
